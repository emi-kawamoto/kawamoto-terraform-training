# 集約関数をwindow関数として扱う
## 1. COUNT()

SQL基礎で使用した, `shop` データベースの `Shohin`　テーブルを使用します。

> 店長は在庫管理をするために、商品と商品分類の在庫数一覧をテーブルから取り出そうとしています。  
> 
> 下記の条件を満たすテーブルを出力するクエリを作成してください。
> - カラム
>   - 商品ID
>   - 商品名
>   - 商品分類
>   - 同値の商品名を持つレコード数(shohin_idは異なっても、同じshohin_meiの場合は同値とみなします)
>   - 同値の商品分類を持つレコード数
> - 表示順：shohin_id 昇順
> - 集計したカラムは適切な別名をつけましょう
> - 可読性を意識したクエリを書いてみましょう

<details>
<summary>出力例</summary>

| shohin_id | shohin_mei            | shohin_bunrui      | shohin_count | bunrui_count |
|----|----|----|----|----|
| 0001      | Tシャツ               | 衣服               |            1 |            2 |
| 0002      | 穴あけパンチ          | 事務用品           |            1 |            2 |
| 0003      | カッターシャツ        | 衣服               |            1 |            2 |
| 0004      | 包丁                  | キッチン用品       |            1 |            4 |
| 0005      | 圧力鍋                | キッチン用品       |            1 |            4 |
| 0006      | フォーク              | キッチン用品       |            1 |            4 |
| 0007      | おろしがね            | キッチン用品       |            1 |            4 |
| 0008      | ボールペン            | 事務用品           |            1 |            2 |


</details>

```sql
ここに回答を書きます
```

----
## 2. SUM()

Day1で作成した、`sns`データベースの`activity_reports`テーブルと`users`テーブルを使用します。
<details>
<summary>スキーマ</summary>

```sql
CREATE TABLE activity_reports(
    date DATE NOT NULL,
    user_id INTEGER NOT NULL,
    post_id VARCHAR(256) NOT NULL,
    impressions INTEGER NOT NULL,
    clicks INTEGER NOT NULL,
    PRIMARY KEY (date, user_id, post_id)
)
;

INSERT INTO activity_reports
VALUES
('2021-10-01',1,'0000a',367,38),
('2021-10-01',2,'0000b',190,31),
('2021-10-01',3,'0000c',48,12),
('2021-10-01',4,'0000d',578,240),
('2021-10-01',5,'0000e',192,45),
('2021-10-02',1,'0000a',200,45),
('2021-10-02',2,'0000b',143,50),
('2021-10-02',3,'0000c',50,20),
('2021-10-02',4,'0000d',200,36),
('2021-10-02',5,'0000e',100,34),
('2021-10-03',1,'0000a',312,34),
('2021-10-03',2,'0000b',572,200),
('2021-10-03',3,'0000c',483,28),
('2021-10-03',4,'0000d',249,15),
('2021-10-03',5,'0000e',109,49);
```
</details>

> ウサギさんは、自分とタヌキさんのSNSの投稿がどれだけの人にみられ、クリックされたかを分析したいようです。  
> 1日ごとにどれくらい増えたのかグラフにしたいので、その日時点の総impと総clickとその日増加分が必要です。
> 
> 以下の条件を満たすクエリを作成してください
> - カラム
>   - 投稿者のユーザー名(ウサギ、タヌキのみ)
>   - 投稿日
>   - 投稿ID
>   - その日のimpressions
>   - その日時点の総impressions
>   - その日のclicks
>   - その日時点の総clicks
> - 集計したカラムには適切な別名をつけましょう。
> - 可読性を意識したクエリを書いてみましょう。

<details>
<summary>出力例</summary>

| user_name | date       | post_id | imp | imp_sum | click | click_sum |
|----|----|----|----|----|----|----|
| ウサギ | 2021-10-01 | 0000b   | 190 |     190 |    31 |        31 |
| ウサギ | 2021-10-02 | 0000b   | 143 |     333 |    50 |        81 |
| ウサギ | 2021-10-03 | 0000b   | 572 |     905 |   200 |       281 |
| タヌキ    | 2021-10-01 | 0000a   | 367 |     367 |    38 |        38 |
| タヌキ    | 2021-10-02 | 0000a   | 200 |     567 |    45 |        83 |
| タヌキ    | 2021-10-03 | 0000a   | 312 |     879 |    34 |       117 |

</details>

```sql
ここに回答を書きます
```
----
## 3. MIN/MAX()
Day1で作成した、`sns`データベースの`activity_reports`テーブルと`users`テーブルを使用します。

<details>
<summary>データを追加してください</summary>

```sql
INSERT INTO activity_reports
VALUES
('2021-10-04',1,'0000a',351,38),
('2021-10-04',2,'0000b',130,31),
('2021-10-04',3,'0000c',400,12),
('2021-10-04',4,'0000d',378,200),
('2021-10-04',5,'0000e',182,46),
('2021-10-05',1,'0000a',100,41),
('2021-10-05',2,'0000b',471,343),
('2021-10-05',3,'0000c',523,233),
('2021-10-05',4,'0000d',245,54),
('2021-10-05',5,'0000e',189,31),
('2021-10-06',1,'0000a',100,65),
('2021-10-06',2,'0000b',500,220),
('2021-10-06',3,'0000c',431,282),
('2021-10-06',4,'0000d',283,152),
('2021-10-06',5,'0000e',140,89),
('2021-10-07',1,'0000a',320,100),
('2021-10-07',2,'0000b',101,31),
('2021-10-07',3,'0000c',68,22),
('2021-10-07',4,'0000d',388,243),
('2021-10-07',5,'0000e',123,87),
('2021-10-08',1,'0000a',154,35),
('2021-10-08',2,'0000b',123,53),
('2021-10-08',3,'0000c',72,21),
('2021-10-08',4,'0000d',23,37),
('2021-10-08',5,'0000e',100,39),
('2021-10-09',1,'0000a',412,190),
('2021-10-09',2,'0000b',232,132),
('2021-10-09',3,'0000c',183,40),
('2021-10-09',4,'0000d',289,134),
('2021-10-09',5,'0000e',102,39);
```

</details>

> このSNSの管理者であるあなたはユーザーの過去3日間の最小click数と最大click数を表すレポートを通知しています。
> 2021-10-05のレポートを作成するクエリを考えてみましょう。
> 
> 以下の条件を満たすクエリを作成してください。
> - カラム 
>   - ユーザー名
>   - レポート日付
>   - レポート日付のclick数
>   - 過去3日間で最もclick数が小さかった日のclick数
>   - 過去3日間で最もclick数が大きかった日のclick数
> - 集計したカラムには適切な別名をつけましょう。
> - 可読性を意識したクエリを書いてみましょう。

<details>
<summary>出力例</summary>

| name            | date       | clicks | click_min_past_3days | click_max_past_3days |
|----|----|----|----|----|
| タヌキ          | 2021-10-05 |     41 |                   34 |                   41 |
| ウサギ          | 2021-10-05 |    343 |                   31 |                  343 |
| ネコ            | 2021-10-05 |    233 |                   12 |                  233 |
| ネズミ          | 2021-10-05 |     54 |                   15 |                  200 |
| アルマジロ      | 2021-10-05 |     31 |                   31 |                   49 |

</details>

```sql
ここに回答を書きます
```

<details>
<summary>ヒント１</summary>
ユーザごとの、日付順の、2日前のカラムから現在カラムまでを集計するようなwindowを作成してみましょう。
</details>

<details>
<summary>ヒント２</summary>
SELECT句の呼び出しはWHERE句の後なので、最初に'2021-10-05'で絞り込んでしまうと、過去分のレコードが読み込まれず求めた結果が得られません。  
全てのdateフィールドの集計結果から、'2021-10-05'を持つレコードだけを取り出すような処理を書きましょう。
</details>